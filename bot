import sqlite3
import telebot
from datetime import datetime
from telebot import types
from datetime import datetime, timedelta
import os

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ—Ç–∞
bot = telebot.TeleBot('8016934708:AAE1VoVqm1blhk0B-hRW6CbP_CpwoUx0T7E')  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à —Ç–æ–∫–µ–Ω

# –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_states = {}

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY,
        chat_id INTEGER UNIQUE,
        phone TEXT,
        name TEXT,
        password TEXT
    )
    ''')
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS events (
        id INTEGER PRIMARY KEY,
        title TEXT,
        date TEXT,
        price INTEGER,
        description TEXT,
        image_path TEXT
    )
    ''')
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –±–∏–ª–µ—Ç–æ–≤
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS tickets (
        user_id INTEGER,
        event_id INTEGER,
        FOREIGN KEY (user_id) REFERENCES users (id),
        FOREIGN KEY (event_id) REFERENCES events (id),
        PRIMARY KEY (user_id, event_id)
    )
    ''')
    
    # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–ø–∏—Å–∫–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('''
    CREATE TABLE IF NOT EXISTS user_lists (
        user_id INTEGER UNIQUE,
        is_blacklisted BOOLEAN DEFAULT 0,
        is_whitelisted BOOLEAN DEFAULT 0,
        FOREIGN KEY (user_id) REFERENCES users (id)
    )
    ''')
    cursor.execute("PRAGMA table_info(events)")
    columns = [column[1] for column in cursor.fetchall()]
    
    if 'image_path' not in columns:
        cursor.execute("ALTER TABLE events ADD COLUMN image_path TEXT")
    conn.commit()
    conn.close()

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
init_db()

# ID –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ 
ADMIN_ID = 818795162  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à ID

# –ü–∞–ø–∫–∞ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
IMAGE_FOLDER = 'event_images'
if not os.path.exists(IMAGE_FOLDER):
    os.makedirs(IMAGE_FOLDER)

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –±–∏–ª–µ—Ç–æ–≤ –Ω–∞ –ø—Ä–æ—à–µ–¥—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
def cleanup_past_events():
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    
    today = datetime.now().strftime('%Y-%m-%d')
    
    # –ù–∞—Ö–æ–¥–∏–º ID –ø—Ä–æ—à–µ–¥—à–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π
    cursor.execute("SELECT id FROM events WHERE date < ?", (today,))
    past_event_ids = [row[0] for row in cursor.fetchall()]
    
    if past_event_ids:
        # –£–¥–∞–ª—è–µ–º –±–∏–ª–µ—Ç—ã –Ω–∞ —ç—Ç–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        cursor.executemany(
            "DELETE FROM tickets WHERE event_id = ?",
            [(event_id,) for event_id in past_event_ids]
        )
        conn.commit()
    
    conn.close()

# –í—ã–∑—ã–≤–∞–µ–º –æ—á–∏—Å—Ç–∫—É –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
cleanup_past_events()

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

def get_user(chat_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE chat_id = ?", (chat_id,))
    user = cursor.fetchone()
    conn.close()
    return user

def get_user_by_phone(phone):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE phone = ?", (phone,))
    user = cursor.fetchone()
    conn.close()
    return user

def add_user(chat_id, phone, name, password):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO users (chat_id, phone, name, password) VALUES (?, ?, ?, ?)",
            (chat_id, phone, name, password)
        )
        user_id = cursor.lastrowid
        conn.commit()
        return user_id
    except sqlite3.IntegrityError:
        return None
    finally:
        conn.close()

def get_upcoming_events():
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    today = datetime.now().strftime('%Y-%m-%d')
    cursor.execute("SELECT * FROM events WHERE date >= ? ORDER BY date LIMIT 10", (today,))
    events = cursor.fetchall()
    conn.close()
    return events

def get_event(event_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM events WHERE id = ?", (event_id,))
    event = cursor.fetchone()
    conn.close()
    return event

def add_event(title, date, price, description, image_path=None):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT INTO events (title, date, price, description, image_path) VALUES (?, ?, ?, ?, ?)",
            (title, date, price, description, image_path)
        )
        event_id = cursor.lastrowid
        conn.commit()
        return event_id
    except Exception as e:
        print(f"Error adding event: {e}")
        return None
    finally:
        conn.close()

def update_event_date(event_id, new_date):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "UPDATE events SET date = ? WHERE id = ?",
            (new_date, event_id)
        )
        conn.commit()
        return True
    except Exception as e:
        print(f"Error updating event date: {e}")
        return False
    finally:
        conn.close()

def update_event_image(event_id, image_path):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "UPDATE events SET image_path = ? WHERE id = ?",
            (image_path, event_id)
        )
        conn.commit()
        return True
    except Exception as e:
        print(f"Error updating event image: {e}")
        return False
    finally:
        conn.close()

def add_ticket(user_id, event_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤ —á–µ—Ä–Ω–æ–º –ª–∏ —Å–ø–∏—Å–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        cursor.execute("SELECT is_blacklisted FROM user_lists WHERE user_id = ?", (user_id,))
        result = cursor.fetchone()
        if result and result[0]:
            return "blacklisted"
        
        cursor.execute(
            "INSERT INTO tickets (user_id, event_id) VALUES (?, ?)",
            (user_id, event_id)
        )
        conn.commit()
        return "success"
    except sqlite3.IntegrityError:
        return "already_exists"
    finally:
        conn.close()

def get_user_tickets(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute('''
    SELECT e.id, e.title, e.date, e.price 
    FROM tickets t
    JOIN events e ON t.event_id = e.id
    WHERE t.user_id = ?
    ''', (user_id,))
    tickets = cursor.fetchall()
    conn.close()
    return tickets

def is_user_whitelisted(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT is_whitelisted FROM user_lists WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result and result[0]

def is_user_blacklisted(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT is_blacklisted FROM user_lists WHERE user_id = ?", (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result and result[0]

def add_to_blacklist(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT OR REPLACE INTO user_lists (user_id, is_blacklisted, is_whitelisted) VALUES (?, 1, 0)",
            (user_id,)
        )
        conn.commit()
        return True
    except Exception as e:
        print(f"Error adding to blacklist: {e}")
        return False
    finally:
        conn.close()

def add_to_whitelist(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute(
            "INSERT OR REPLACE INTO user_lists (user_id, is_whitelisted, is_blacklisted) VALUES (?, 1, 0)",
            (user_id,)
        )
        conn.commit()
        return True
    except Exception as e:
        print(f"Error adding to whitelist: {e}")
        return False
    finally:
        conn.close()

def remove_from_lists(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        cursor.execute("DELETE FROM user_lists WHERE user_id = ?", (user_id,))
        conn.commit()
        return True
    except Exception as e:
        print(f"Error removing from lists: {e}")
        return False
    finally:
        conn.close()

def get_user_by_id(user_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM users WHERE id = ?", (user_id,))
    user = cursor.fetchone()
    conn.close()
    return user

def refund_ticket(user_id, event_id):
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π –±–∏–ª–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        cursor.execute("""
            SELECT 1 FROM tickets 
            WHERE user_id = ? AND event_id = ?
        """, (user_id, event_id))
        if not cursor.fetchone():
            return "not_found"
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        cursor.execute("SELECT date FROM events WHERE id = ?", (event_id,))
        event_date_str = cursor.fetchone()[0]
        event_date = datetime.strptime(event_date_str, '%Y-%m-%d').date()
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –æ—Å—Ç–∞–ª–æ—Å—å –±–æ–ª–µ–µ 7 –¥–Ω–µ–π
        today = datetime.now().date()
        days_until_event = (event_date - today).days
        
        if days_until_event < 7:
            return "too_late"
        
        # –£–¥–∞–ª—è–µ–º –±–∏–ª–µ—Ç
        cursor.execute("""
            DELETE FROM tickets 
            WHERE user_id = ? AND event_id = ?
        """, (user_id, event_id))
        conn.commit()
        return "success"
    except Exception as e:
        print(f"Error refunding ticket: {e}")
        return "error"
    finally:
        conn.close()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥
@bot.message_handler(commands=['start'])
def start(message):
    user = get_user(message.chat.id)
    if user:
        if message.chat.id == ADMIN_ID:
            show_admin_menu(message.chat.id, user[3])
        else:
            show_main_menu(message.chat.id, user[3])
    else:
        show_auth_menu(message.chat.id)

def show_auth_menu(chat_id):
    markup = types.ReplyKeyboardMarkup(one_time_keyboard=True, resize_keyboard=True)
    markup.add('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', '–í—Ö–æ–¥')
    bot.send_message(chat_id, '–ü—Ä–∏–≤–µ—Ç! –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:', reply_markup=markup)

def show_main_menu(chat_id, name=None):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã')
    markup.add('üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É', 'üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞')
    text = f"–ü—Ä–∏–≤–µ—Ç, {name}!" if name else "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
    bot.send_message(chat_id, text, reply_markup=markup)

def show_admin_menu(chat_id, name=None):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è', 'üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã')
    markup.add('üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏', '‚úèÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏', 'üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞')
    text = f"–ü—Ä–∏–≤–µ—Ç, –ê–¥–º–∏–Ω {name}!" if name else "–ê–¥–º–∏–Ω –º–µ–Ω—é"
    bot.send_message(chat_id, text, reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == '‚úèÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è–º–∏' and message.chat.id == ADMIN_ID)
def manage_events(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é', '‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ')
    bot.send_message(
        message.chat.id,
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=markup
    )
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π —Å –∫–Ω–æ–ø–∫–∞–º–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    events = get_upcoming_events()
    if not events:
        bot.send_message(message.chat.id, "–ù–µ—Ç –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.")
        return
    
    markup = types.InlineKeyboardMarkup()
    for event in events:
        markup.add(types.InlineKeyboardButton(
            text=f"‚úèÔ∏è {event[1]} ({event[2]})",
            callback_data=f"edit_event_{event[0]}"
        ))
    
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:", reply_markup=markup)

@bot.message_handler(func=lambda message: message.text == '‚ûï –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ' and message.chat.id == ADMIN_ID)
def add_event_start(message):
    user_states[message.chat.id] = {'state': 'add_event_title'}
    bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:", reply_markup=types.ForceReply())

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'add_event_title')
def add_event_get_title(message):
    user_states[message.chat.id] = {
        'state': 'add_event_date',
        'title': message.text
    }
    bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î:")

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'add_event_date')
def add_event_get_date(message):
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
        datetime.strptime(message.text, '%Y-%m-%d')
        user_states[message.chat.id] = {
            'state': 'add_event_price',
            'title': user_states[message.chat.id]['title'],
            'date': message.text
        }
        bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É –±–∏–ª–µ—Ç–∞ (—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ):")
    except ValueError:
        bot.send_message(message.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î")

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'add_event_price')
def add_event_get_price(message):
    if not message.text.isdigit():
        bot.send_message(message.chat.id, "‚ùå –¶–µ–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ü–µ–ª—ã–º —á–∏—Å–ª–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:")
        return
    
    user_states[message.chat.id] = {
        'state': 'add_event_description',
        'title': user_states[message.chat.id]['title'],
        'date': user_states[message.chat.id]['date'],
        'price': int(message.text)
    }
    bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:")

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'add_event_description')
def add_event_get_description(message):
    user_states[message.chat.id] = {
        'state': 'add_event_image',
        'title': user_states[message.chat.id]['title'],
        'date': user_states[message.chat.id]['date'],
        'price': user_states[message.chat.id]['price'],
        'description': message.text
    }
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å')
    bot.send_message(
        message.chat.id,
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å':",
        reply_markup=markup
    )

@bot.message_handler(content_types=['photo'], func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'add_event_image')
def add_event_save_with_image(message):
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        event_data = user_states[message.chat.id]
        
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        file_id = message.photo[-1].file_id
        file_info = bot.get_file(file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image_path = os.path.join(IMAGE_FOLDER, f"event_{datetime.now().timestamp()}.jpg")
        with open(image_path, 'wb') as new_file:
            new_file.write(downloaded_file)
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤ –ë–î
        event_id = add_event(
            event_data['title'],
            event_data['date'],
            event_data['price'],
            event_data['description'],
            image_path
        )
        
        if event_id:
            bot.send_message(
                message.chat.id,
                f"‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ '{event_data['title']}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º!",
                reply_markup=types.ReplyKeyboardRemove()
            )
            show_admin_menu(message.chat.id)
        else:
            bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")
    except Exception as e:
        print(f"Error adding event with image: {e}")
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")
    finally:
        if 'state' in user_states.get(message.chat.id, {}):
            del user_states[message.chat.id]

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'add_event_image' and message.text == '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å')
def add_event_save_without_image(message):
    try:
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è
        event_data = user_states[message.chat.id]
        
        # –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –≤ –ë–î –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        event_id = add_event(
            event_data['title'],
            event_data['date'],
            event_data['price'],
            event_data['description']
        )
        
        if event_id:
            bot.send_message(
                message.chat.id,
                f"‚úÖ –ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ '{event_data['title']}' —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è!",
                reply_markup=types.ReplyKeyboardRemove()
            )
            show_admin_menu(message.chat.id)
        else:
            bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")
    except Exception as e:
        print(f"Error adding event without image: {e}")
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è")
    finally:
        if 'state' in user_states.get(message.chat.id, {}):
            del user_states[message.chat.id]

@bot.callback_query_handler(func=lambda call: call.data.startswith('edit_event_'))
def edit_event(call):
    event_id = int(call.data.split('_')[2])
    event = get_event(event_id)
    
    if not event:
        bot.answer_callback_query(call.id, "–ú–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ")
        return
    
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton(
        text="üìÖ –ò–∑–º–µ–Ω–∏—Ç—å –¥–∞—Ç—É",
        callback_data=f"edit_date_{event_id}"
    ))
    markup.add(types.InlineKeyboardButton(
        text="üñºÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
        callback_data=f"edit_image_{event_id}"
    ))
    markup.add(types.InlineKeyboardButton(
        text="‚óÄÔ∏è –ù–∞–∑–∞–¥",
        callback_data="back_to_events"
    ))
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –µ—Å–ª–∏ –æ–Ω–æ –µ—Å—Ç—å
    if event[5]:  # image_path
        try:
            with open(event[5], 'rb') as photo:
                bot.send_photo(
                    call.message.chat.id,
                    photo,
                    caption=f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {event[1]}\n–î–∞—Ç–∞: {event[2]}\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                    reply_markup=markup
                )
        except Exception as e:
            print(f"Error sending photo: {e}")
            bot.send_message(
                call.message.chat.id,
                f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {event[1]}\n–î–∞—Ç–∞: {event[2]}\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
                reply_markup=markup
            )
    else:
        bot.send_message(
            call.message.chat.id,
            f"–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: {event[1]}\n–î–∞—Ç–∞: {event[2]}\n–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
            reply_markup=markup
        )

@bot.callback_query_handler(func=lambda call: call.data.startswith('edit_date_'))
def edit_event_date(call):
    event_id = int(call.data.split('_')[2])
    user_states[call.message.chat.id] = {
        'state': 'waiting_event_date',
        'event_id': event_id
    }
    
    bot.send_message(
        call.message.chat.id,
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –¥–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2026-12-31):",
        reply_markup=types.ForceReply()
    )

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'waiting_event_date')
def save_event_date(message):
    event_id = user_states[message.chat.id]['event_id']
    new_date = message.text
    
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞—Ç—ã
        datetime.strptime(new_date, '%Y-%m-%d')
    except ValueError:
        bot.send_message(message.chat.id, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞—Ç—ã. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ì–ì–ì–ì-–ú–ú-–î–î")
        return
    
    if update_event_date(event_id, new_date):
        bot.send_message(message.chat.id, "‚úÖ –î–∞—Ç–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!")
        event = get_event(event_id)
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton(
            text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é",
            callback_data=f"edit_event_{event_id}"
        ))
        bot.send_message(
            message.chat.id,
            f"–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:\n{event[1]}\n–î–∞—Ç–∞: {new_date}",
            reply_markup=markup
        )
    else:
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç—ã")
    
    del user_states[message.chat.id]

@bot.callback_query_handler(func=lambda call: call.data.startswith('edit_image_'))
def edit_event_image(call):
    event_id = int(call.data.split('_')[2])
    user_states[call.message.chat.id] = {
        'state': 'waiting_event_image',
        'event_id': event_id
    }
    
    bot.send_message(
        call.message.chat.id,
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è:",
        reply_markup=types.ForceReply()
    )

@bot.message_handler(content_types=['photo'], func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'waiting_event_image')
def save_event_image(message):
    event_id = user_states[message.chat.id]['event_id']
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        file_id = message.photo[-1].file_id
        file_info = bot.get_file(file_id)
        downloaded_file = bot.download_file(file_info.file_path)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image_path = os.path.join(IMAGE_FOLDER, f"event_{event_id}_{file_id}.jpg")
        with open(image_path, 'wb') as new_file:
            new_file.write(downloaded_file)
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—É—Ç—å –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        if update_event_image(event_id, image_path):
            bot.send_message(message.chat.id, "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!")
            event = get_event(event_id)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            try:
                with open(image_path, 'rb') as photo:
                    markup = types.InlineKeyboardMarkup()
                    markup.add(types.InlineKeyboardButton(
                        text="‚óÄÔ∏è –ù–∞–∑–∞–¥ –∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—é",
                        callback_data=f"edit_event_{event_id}"
                    ))
                    bot.send_photo(
                        message.chat.id,
                        photo,
                        caption=f"–û–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è: {event[1]}",
                        reply_markup=markup
                    )
            except Exception as e:
                print(f"Error sending updated photo: {e}")
                bot.send_message(message.chat.id, "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ, –Ω–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–æ–∫–∞–∑–∞–Ω–æ.")
        else:
            bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
    except Exception as e:
        print(f"Error saving image: {e}")
        bot.send_message(message.chat.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
    
    del user_states[message.chat.id]

@bot.callback_query_handler(func=lambda call: call.data == 'back_to_events')
def back_to_events(call):
    manage_events(call.message)

@bot.message_handler(func=lambda message: message.text == 'üí¨ –ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É')
def contact_support(message):
    user = get_user(message.chat.id)
    if not user:
        bot.send_message(message.chat.id, 'üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.')
        return
    
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('‚óÄÔ∏è –û—Ç–º–µ–Ω–∞')
    bot.send_message(
        message.chat.id,
        "–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –∫–∞–∫ –º–æ–∂–Ω–æ —Å–∫–æ—Ä–µ–µ:",
        reply_markup=markup
    )
    user_states[message.chat.id] = {'state': 'waiting_support_message'}

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'waiting_support_message')
def handle_support_message(message):
    if message.text == '‚óÄÔ∏è –û—Ç–º–µ–Ω–∞':
        del user_states[message.chat.id]
        show_main_menu(message.chat.id)
        return
    
    user = get_user(message.chat.id)
    if not user:
        del user_states[message.chat.id]
        bot.send_message(message.chat.id, '‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω')
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
    try:
        bot.send_message(
            ADMIN_ID,
            f"‚úâÔ∏è –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {user[3]} ({user[2]}):\n\n{message.text}\n\nID —á–∞—Ç–∞: {message.chat.id}"
        )
        bot.send_message(
            message.chat.id,
            "‚úÖ –í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É. –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.",
            reply_markup=types.ReplyKeyboardRemove()
        )
        show_main_menu(message.chat.id, user[3])
    except Exception as e:
        bot.send_message(
            message.chat.id,
            "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )
    finally:
        del user_states[message.chat.id]

@bot.message_handler(func=lambda message: message.text == 'üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏' and message.chat.id == ADMIN_ID)
def manage_users(message):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True)
    markup.add('‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é')
    bot.send_message(
        message.chat.id,
        "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–≤ —Ñ–æ—Ä–º–∞—Ç–µ 79998887766) –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
        reply_markup=markup
    )
    bot.register_next_step_handler(message, process_user_phone_for_management)

def process_user_phone_for_management(message):
    if message.text == '‚óÄÔ∏è –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é':
        show_admin_menu(message.chat.id)
        return
    
    phone = message.text
    user = get_user_by_phone(phone)
    
    if not user:
        bot.send_message(message.chat.id, "‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        show_admin_menu(message.chat.id)
        return
    
    user_id = user[0]
    is_blacklisted = is_user_blacklisted(user_id)
    is_whitelisted = is_user_whitelisted(user_id)
    
    markup = types.InlineKeyboardMarkup()
    
    if not is_blacklisted:
        markup.add(types.InlineKeyboardButton(
            text="‚õî –î–æ–±–∞–≤–∏—Ç—å –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫",
            callback_data=f"blacklist_{user_id}"
        ))
    else:
        markup.add(types.InlineKeyboardButton(
            text="‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞",
            callback_data=f"unblacklist_{user_id}"
        ))
    
    if not is_whitelisted:
        markup.add(types.InlineKeyboardButton(
            text="‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫",
            callback_data=f"whitelist_{user_id}"
        ))
    else:
        markup.add(types.InlineKeyboardButton(
            text="üîª –£–±—Ä–∞—Ç—å –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞",
            callback_data=f"unwhitelist_{user_id}"
        ))
    
    bot.send_message(
        message.chat.id,
        f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: {user[3]} ({user[2]})\n"
        f"–°—Ç–∞—Ç—É—Å—ã:\n"
        f"–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫: {'–î–∞' if is_blacklisted else '–ù–µ—Ç'}\n"
        f"–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: {'–î–∞' if is_whitelisted else '–ù–µ—Ç'}",
        reply_markup=markup
    )
    show_admin_menu(message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data.startswith(('blacklist_', 'unblacklist_', 'whitelist_', 'unwhitelist_')))
def handle_list_management(call):
    action, user_id = call.data.split('_')
    user_id = int(user_id)
    
    if call.message.chat.id != ADMIN_ID:
        bot.answer_callback_query(call.id, "‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è")
        return
    
    if action == 'blacklist':
        if add_to_blacklist(user_id):
            bot.answer_callback_query(call.id, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫")
        else:
            bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫")
    
    elif action == 'unblacklist':
        if remove_from_lists(user_id):
            bot.answer_callback_query(call.id, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–±—Ä–∞–Ω –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞")
        else:
            bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞")
    
    elif action == 'whitelist':
        if add_to_whitelist(user_id):
            bot.answer_callback_query(call.id, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫")
        else:
            bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫")
    
    elif action == 'unwhitelist':
        if remove_from_lists(user_id):
            bot.answer_callback_query(call.id, "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–±—Ä–∞–Ω –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞")
        else:
            bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    user = get_user_by_id(user_id)
    is_blacklisted = is_user_blacklisted(user_id)
    is_whitelisted = is_user_whitelisted(user_id)
    
    markup = types.InlineKeyboardMarkup()
    
    if not is_blacklisted:
        markup.add(types.InlineKeyboardButton(
            text="‚õî –î–æ–±–∞–≤–∏—Ç—å –≤ —á–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫",
            callback_data=f"blacklist_{user_id}"
        ))
    else:
        markup.add(types.InlineKeyboardButton(
            text="‚úÖ –£–±—Ä–∞—Ç—å –∏–∑ —á–µ—Ä–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞",
            callback_data=f"unblacklist_{user_id}"
        ))
    
    if not is_whitelisted:
        markup.add(types.InlineKeyboardButton(
            text="‚≠ê –î–æ–±–∞–≤–∏—Ç—å –≤ –±–µ–ª—ã–π —Å–ø–∏—Å–æ–∫",
            callback_data=f"whitelist_{user_id}"
        ))
    else:
        markup.add(types.InlineKeyboardButton(
            text="üîª –£–±—Ä–∞—Ç—å –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞",
            callback_data=f"unwhitelist_{user_id}"
        ))
    
    bot.edit_message_text(
        chat_id=call.message.chat.id,
        message_id=call.message.message_id,
        text=f"–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: {user[3]} ({user[2]})\n"
             f"–°—Ç–∞—Ç—É—Å—ã:\n"
             f"–ß–µ—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫: {'–î–∞' if is_blacklisted else '–ù–µ—Ç'}\n"
             f"–ë–µ–ª—ã–π —Å–ø–∏—Å–æ–∫: {'–î–∞' if is_whitelisted else '–ù–µ—Ç'}",
        reply_markup=markup
    )

@bot.message_handler(func=lambda message: message.text == '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è')
def register_start(message):
    user_states[message.chat.id] = {'state': 'waiting_phone'}
    bot.send_message(message.chat.id, 'üì± –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–≤ —Ñ–æ—Ä–º–∞—Ç–µ 79998887766):', reply_markup=types.ForceReply())

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'waiting_phone')
def register_get_phone(message):
    if not message.text.isdigit() or len(message.text) != 11:
        bot.send_message(message.chat.id, '‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑:')
        return
    
    user_states[message.chat.id] = {
        'state': 'waiting_name',
        'phone': message.text
    }
    bot.send_message(message.chat.id, 'üë§ –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:')

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'waiting_name')
def register_get_name(message):
    user_states[message.chat.id]['state'] = 'waiting_password'
    user_states[message.chat.id]['name'] = message.text
    bot.send_message(message.chat.id, 'üîë –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å:')

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'waiting_password')
def register_finish(message):
    phone = user_states[message.chat.id]['phone']
    name = user_states[message.chat.id]['name']
    password = message.text
    
    if add_user(message.chat.id, phone, name, password):
        del user_states[message.chat.id]
        show_main_menu(message.chat.id, name)
        bot.send_message(message.chat.id, '‚úÖ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!')
    else:
        bot.send_message(message.chat.id, '‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –í–æ–∑–º–æ–∂–Ω–æ, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç. /start')

@bot.message_handler(func=lambda message: message.text == '–í—Ö–æ–¥')
def login_start(message):
    user_states[message.chat.id] = {'state': 'login_phone'}
    bot.send_message(message.chat.id, 'üì± –í–≤–µ–¥–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞:')

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'login_phone')
def login_get_phone(message):
    user = get_user_by_phone(message.text)
    
    if user:
        user_states[message.chat.id] = {
            'state': 'login_password',
            'phone': message.text,
            'user_id': user[0]
        }
        bot.send_message(message.chat.id, 'üîë –í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å:')
    else:
        del user_states[message.chat.id]
        bot.send_message(message.chat.id, '‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω.')

@bot.message_handler(func=lambda message: user_states.get(message.chat.id, {}).get('state') == 'login_password')
def login_check_password(message):
    phone = user_states[message.chat.id]['phone']
    user_id = user_states[message.chat.id]['user_id']
    
    conn = sqlite3.connect('events_bot.db')
    cursor = conn.cursor()
    cursor.execute("SELECT name FROM users WHERE phone = ? AND password = ?", (phone, message.text))
    user = cursor.fetchone()
    conn.close()
    
    if user:
        del user_states[message.chat.id]
        if message.chat.id == ADMIN_ID:
            show_admin_menu(message.chat.id, user[0])
        else:
            show_main_menu(message.chat.id, user[0])
        bot.send_message(message.chat.id, '‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!')
    else:
        bot.send_message(message.chat.id, '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.')

@bot.message_handler(func=lambda message: message.text == 'üö™ –í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞')
def logout(message):
    bot.send_message(message.chat.id, "–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞.")
    show_auth_menu(message.chat.id)

@bot.message_handler(func=lambda message: message.text == 'üìÖ –ë–ª–∏–∂–∞–π—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è')
def show_upcoming_events(message):
    # –û—á–∏—â–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
    cleanup_past_events()
    
    user = get_user(message.chat.id)
    if not user:
        bot.send_message(message.chat.id, 'üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.')
        return
    
    if is_user_blacklisted(user[0]):
        bot.send_message(message.chat.id, '‚õî –í—ã –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è.')
        return
    
    events = get_upcoming_events()
    
    if not events:
        bot.send_message(message.chat.id, '‚ÑπÔ∏è –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π.')
        return
    
    for event in events:
        price = event[3]
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
        if is_user_whitelisted(user[0]):
            discount = int(price * 0.2)
            price_text = f"<s>{price}</s> {price - discount} —Ä—É–±. (—Å–∫–∏–¥–∫–∞ 20%)"
        else:
            price_text = f"{price} —Ä—É–±."
        
        response = f"<b>üé≠ {event[1]}</b>\n"
        response += f"üìÖ <i>–î–∞—Ç–∞:</i> {event[2]}\n"
        response += f"üí∞ <i>–¶–µ–Ω–∞:</i> {price_text}\n"
        response += f"‚ÑπÔ∏è <i>–û–ø–∏—Å–∞–Ω–∏–µ:</i> {event[4]}\n\n"
        
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton(
            text="–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç",
            callback_data=f"buy_{event[0]}"
        ))
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –µ–≥–æ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º
        if event[5]:
            try:
                with open(event[5], 'rb') as photo:
                    bot.send_photo(
                        message.chat.id,
                        photo,
                        caption=response,
                        parse_mode='HTML',
                        reply_markup=markup
                    )
            except Exception as e:
                print(f"Error sending photo: {e}")
                bot.send_message(
                    message.chat.id,
                    response,
                    parse_mode='HTML',
                    reply_markup=markup
                )
        else:
            bot.send_message(
                message.chat.id,
                response,
                parse_mode='HTML',
                reply_markup=markup
            )

@bot.callback_query_handler(func=lambda call: call.data.startswith('buy_'))
def buy_ticket(call):
    user = get_user(call.message.chat.id)
    if not user:
        bot.answer_callback_query(call.id, "üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É")
        return
    
    if is_user_blacklisted(user[0]):
        bot.answer_callback_query(call.id, "‚õî –í—ã –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–∫—É–ø–∞—Ç—å –±–∏–ª–µ—Ç—ã")
        return
    
    event_id = int(call.data.split('_')[1])
    result = add_ticket(user[0], event_id)
    
    if result == "blacklisted":
        bot.answer_callback_query(call.id, "‚õî –í—ã –≤ —á–µ—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏ –Ω–µ –º–æ–∂–µ—Ç–µ –ø–æ–∫—É–ø–∞—Ç—å –±–∏–ª–µ—Ç—ã")
    elif result == "already_exists":
        bot.answer_callback_query(call.id, "‚ÑπÔ∏è –£ –≤–∞—Å —É–∂–µ –µ—Å—Ç—å –±–∏–ª–µ—Ç –Ω–∞ —ç—Ç–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–µ")
    elif result == "success":
        conn = sqlite3.connect('events_bot.db')
        cursor = conn.cursor()
        cursor.execute("SELECT title, price FROM events WHERE id = ?", (event_id,))
        event_title, price = cursor.fetchone()
        conn.close()
        
        # –ü—Ä–∏–º–µ–Ω—è–µ–º —Å–∫–∏–¥–∫—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ –±–µ–ª–æ–≥–æ —Å–ø–∏—Å–∫–∞
        if is_user_whitelisted(user[0]):
            discount = int(price * 0.2)  # 20% —Å–∫–∏–¥–∫–∞
            bot.answer_callback_query(
                call.id, 
                f"‚úÖ –í—ã –∫—É–ø–∏–ª–∏ –±–∏–ª–µ—Ç –Ω–∞ {event_title} —Å–æ —Å–∫–∏–¥–∫–æ–π 20%! (-{discount} —Ä—É–±.)"
            )
        else:
            bot.answer_callback_query(call.id, f"‚úÖ –í—ã –∫—É–ø–∏–ª–∏ –±–∏–ª–µ—Ç –Ω–∞ {event_title}!")

@bot.message_handler(func=lambda message: message.text == 'üé´ –ú–æ–∏ –±–∏–ª–µ—Ç—ã')
def show_user_events(message):
    # –û—á–∏—â–∞–µ–º –ø—Ä–æ—à–µ–¥—à–∏–µ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º
    cleanup_past_events()
    
    user = get_user(message.chat.id)
    if not user:
        bot.send_message(message.chat.id, 'üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É.')
        return
    
    tickets = get_user_tickets(user[0])
    
    if not tickets:
        bot.send_message(message.chat.id, '‚ÑπÔ∏è –£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∫—É–ø–ª–µ–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤.')
        return
    
    response = "üé´ <b>–í–∞—à–∏ –±–∏–ª–µ—Ç—ã:</b>\n\n"
    today = datetime.now().date()
    markup = types.InlineKeyboardMarkup()
    
    for ticket in tickets:
        event_id = ticket[0]
        event_date = datetime.strptime(ticket[2], '%Y-%m-%d').date()
        days_until_event = (event_date - today).days
        
        if event_date >= today:
            status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω"
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è –±–æ–ª–µ–µ 7 –¥–Ω–µ–π
            if days_until_event >= 7:
                markup.add(types.InlineKeyboardButton(
                    text=f"–í–µ—Ä–Ω—É—Ç—å –±–∏–ª–µ—Ç: {ticket[1]}",
                    callback_data=f"refund_{event_id}"
                ))
            else:
                response += f"‚ö†Ô∏è <i>–í–æ–∑–≤—Ä–∞—Ç –±–∏–ª–µ—Ç–∞ –Ω–∞ '{ticket[1]}' –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω (–º–µ–Ω–µ–µ 7 –¥–Ω–µ–π –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è)</i>\n\n"
        else:
            status = "‚ùå –ü—Ä–æ—à–µ–¥—à–µ–µ"
        
        response += f"<b>{ticket[1]}</b> {status}\n"
        response += f"üìÖ –î–∞—Ç–∞: {ticket[2]}\n"
        response += f"üí∞ –¶–µ–Ω–∞: {ticket[3]} —Ä—É–±.\n"
        if event_date >= today and days_until_event >= 7:
            response += f"üîÑ –ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å –¥–æ {event_date - timedelta(days=7)}\n"
        response += "\n"
    
    bot.send_message(message.chat.id, response, parse_mode='HTML', reply_markup=markup)
    
@bot.callback_query_handler(func=lambda call: call.data.startswith('refund_'))
def handle_refund(call):
    user = get_user(call.message.chat.id)
    if not user:
        bot.answer_callback_query(call.id, "üîí –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É")
        return
    
    event_id = int(call.data.split('_')[1])
    result = refund_ticket(user[0], event_id)
    
    if result == "not_found":
        bot.answer_callback_query(call.id, "‚ùå –ë–∏–ª–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
    elif result == "too_late":
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        conn = sqlite3.connect('events_bot.db')
        cursor = conn.cursor()
        cursor.execute("SELECT title, date FROM events WHERE id = ?", (event_id,))
        event_title, event_date = cursor.fetchone()
        conn.close()
        
        bot.answer_callback_query(
            call.id, 
            f"‚ùå –í–æ–∑–≤—Ä–∞—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω: –¥–æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è '{event_title}' ({event_date}) –æ—Å—Ç–∞–ª–æ—Å—å –º–µ–Ω–µ–µ 7 –¥–Ω–µ–π"
        )
    elif result == "error":
        bot.answer_callback_query(call.id, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –±–∏–ª–µ—Ç–∞")
    elif result == "success":
        # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
        conn = sqlite3.connect('events_bot.db')
        cursor = conn.cursor()
        cursor.execute("SELECT title FROM events WHERE id = ?", (event_id,))
        event_title = cursor.fetchone()[0]
        conn.close()
        
        bot.answer_callback_query(call.id, f"‚úÖ –ë–∏–ª–µ—Ç –Ω–∞ {event_title} —É—Å–ø–µ—à–Ω–æ –≤–æ–∑–≤—Ä–∞—â–µ–Ω!")
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –±–∏–ª–µ—Ç–æ–≤
        show_user_events(call.message)

@bot.message_handler(func=lambda message: True)
def handle_other_messages(message):
    bot.send_message(message.chat.id, '‚ùå –Ø –≤–∞—Å –Ω–µ –ø–æ–Ω–∏–º–∞—é. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –∏–ª–∏ –∫–æ–º–∞–Ω–¥—É /start')

if __name__ == '__main__':
    print("ü§ñ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    bot.polling(none_stop=True)
